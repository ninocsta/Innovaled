{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4 text-center">
  <h2 class="mb-4"><i class="bi bi-graph-up-arrow me-2"></i>Dashboard</h2>

  <!-- Filtros -->
  <form method="get" class="row g-3 mb-4 justify-content-center">
    <div class="col-md-4">
      <select name="vendedor" class="form-select shadow-sm" onchange="this.form.submit()">
        <option value="">Todos os vendedores</option>
        {% for v in vendedores %}
          <option value="{{ v.id }}" {% if v.id|stringformat:"s" == selected_vendedor %}selected{% endif %}>{{ v.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <input type="month" name="mes" class="form-control shadow-sm" value="{{ selected_mes }}" onchange="this.form.submit()">
    </div>
  </form>

  <!-- Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 text-center">
        <div class="card-body">
          <h6 class="text-muted"><i class="bi bi-bag-check me-2"></i>Contratos Vendidos</h6>
          <h3 class="fw-bold text-primary">{{ data.contratos_vendidos }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 text-center">
        <div class="card-body">
          <h6 class="text-muted"><i class="bi bi-currency-dollar me-2"></i>Faturamento</h6>
          <h3 class="fw-bold text-success">R$ {{ data.faturamento|floatformat:2 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 text-center">
        <div class="card-body">
          <h6 class="text-muted"><i class="bi bi-bar-chart-line me-2"></i>Ticket Médio</h6>
          <h3 class="fw-bold text-warning">R$ {{ data.ticket_medio|floatformat:2 }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3"><i class="bi bi-pie-chart me-2"></i>Métodos de Pagamento</h6>
          <canvas id="metodosPagamento" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3"><i class="bi bi-calendar3 me-2"></i>Faturamento (últimos 6 meses)</h6>
          <canvas id="faturamentoMes" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Métodos de pagamento
  const metodosPagamento = {
    labels: [{% for m in data.metodos_pagamento %}"{{ m.forma_pagamento__nome }}",{% endfor %}],
    datasets: [{
      label: 'Contratos',
      data: [{% for m in data.metodos_pagamento %}{{ m.total }},{% endfor %}],
      backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1']
    }]
  };
  new Chart(document.getElementById('metodosPagamento'), {
    type: 'pie',
    data: metodosPagamento
  });

  // Faturamento últimos meses
  const faturamentoMes = {
    labels: [{% for f in data.faturamento_por_mes %}"{{ f.data_assinatura__month }}/{{ f.data_assinatura__year }}",{% endfor %}],
    datasets: [{
      label: 'Faturamento',
      data: [{% for f in data.faturamento_por_mes %}{{ f.total|default:0 }},{% endfor %}],
      borderColor: '#0d6efd',
      backgroundColor: 'rgba(13,110,253,0.3)',
      fill: true,
      tension: 0.3
    }]
  };
  new Chart(document.getElementById('faturamentoMes'), {
    type: 'line',
    data: faturamentoMes
  });
</script>
{% endblock %}
