{% extends "base.html" %}

{% block title %}
Usina - Novo Contrato
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-2">
            <a href="{% url 'contratos_list' %}" class="btn btn-info text-light">Voltar</a>
        </div>
        <div class="col-md-8">
            <h1 class="mb-4 text-center">Novo Contrato</h1>
        </div>
        <div class="col-md-2"></div>
    </div>

    <!-- Exibir mensagens de erro ou sucesso -->
    {% if messages %}
    <div class="alert alert-dismissible fade show" role="alert">
        {% for message in messages %}
        <div class="alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
    {% endif %}

    <form method="POST" class="row g-3" id="novo-contrato-form">
        {% csrf_token %}

        <!-- Dados do Cliente -->
        <h4 class="mt-3">ðŸ‘¤ Dados do Cliente</h4>
        <div class="col-md-6 form-group">
            {{ cliente_form.razao_social.label_tag }}
            {{ cliente_form.razao_social }}
            {% if cliente_form.razao_social.errors %}
            <div class="invalid-feedback">{{ cliente_form.razao_social.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ cliente_form.cpf_cnpj.label_tag }}
            {{ cliente_form.cpf_cnpj }}
            {% if cliente_form.cpf_cnpj.errors %}
            <div class="invalid-feedback">{{ cliente_form.cpf_cnpj.errors }}</div>
            {% elif cliente_existente %}
            <div class="text-success">âœ” Cliente jÃ¡ existe e serÃ¡ reutilizado.</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ cliente_form.email.label_tag }}
            {{ cliente_form.email }}
            {% if cliente_form.email.errors %}
            <div class="invalid-feedback">{{ cliente_form.email.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ cliente_form.telefone.label_tag }} <small class="text-muted">(opcional)</small>
            {{ cliente_form.telefone }}
            {% if cliente_form.telefone.errors %}
            <div class="invalid-feedback">{{ cliente_form.telefone.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ cliente_form.telefone_financeiro.label_tag }} <small class="text-muted">(opcional)</small>
            {{ cliente_form.telefone_financeiro }}
            {% if cliente_form.telefone_financeiro.errors %}
            <div class="invalid-feedback">{{ cliente_form.telefone_financeiro.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ cliente_form.email_financeiro.label_tag }} <small class="text-muted">(opcional)</small>
            {{ cliente_form.email_financeiro }}
            {% if cliente_form.email_financeiro.errors %}
            <div class="invalid-feedback">{{ cliente_form.email_financeiro.errors }}</div>
            {% endif %}
        </div>

        <!-- Dados do VÃ­deo -->
        <h4 class="mt-4">ðŸŽ¬ Dados do VÃ­deo</h4>
        <div class="col-md-6 form-group">
            {{ video_form.tempo_video.label_tag }}
            {{ video_form.tempo_video }}
            {% if video_form.tempo_video.errors %}
            <div class="invalid-feedback">{{ video_form.tempo_video.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ video_form.local.label_tag }}
            {{ video_form.local }}
            {% if video_form.local.errors %}
            <div class="invalid-feedback">{{ video_form.local.errors }}</div>
            {% endif %}
        </div>

        <!-- Dados do Contrato -->
        <h4 class="mt-4">ðŸ“‘ Dados do Contrato</h4>
        <div class="col-md-6 form-group">
            {{ contrato_form.vendedor.label_tag }}
            {{ contrato_form.vendedor }}
            {% if contrato_form.vendedor.errors %}
            <div class="invalid-feedback">{{ contrato_form.vendedor.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ contrato_form.banco.label_tag }} <small class="text-muted">(opcional)</small>
            {{ contrato_form.banco }}
            {% if contrato_form.banco.errors %}
            <div class="invalid-feedback">{{ contrato_form.banco.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ contrato_form.vigencia_meses.label_tag }}
            {{ contrato_form.vigencia_meses }}
            {% if contrato_form.vigencia_meses.errors %}
            <div class="invalid-feedback">{{ contrato_form.vigencia_meses.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ contrato_form.valor_mensalidade.label_tag }}
            {{ contrato_form.valor_mensalidade }}
            {% if contrato_form.valor_mensalidade.errors %}
            <div class="invalid-feedback">{{ contrato_form.valor_mensalidade.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            <label for="valor_total">Valor Total (calculado automaticamente)</label>
            <input type="text" id="valor_total" class="form-control" readonly>
        </div>
        <div class="col-md-6 form-group">
            {{ contrato_form.data_assinatura.label_tag }}
            {{ contrato_form.data_assinatura }}
            {% if contrato_form.data_assinatura.errors %}
            <div class="invalid-feedback">{{ contrato_form.data_assinatura.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            {{ contrato_form.data_vencimento_primeira_parcela.label_tag }} <small class="text-muted">(opcional)</small>
            {{ contrato_form.data_vencimento_primeira_parcela }}
            {% if contrato_form.data_vencimento_primeira_parcela.errors %}
            <div class="invalid-feedback">{{ contrato_form.data_vencimento_primeira_parcela.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6 form-group">
            <label for="data_ultima_parcela">Data da Ãšltima Parcela (calculado automaticamente)</label>
            <input type="text" id="data_ultima_parcela" class="form-control" readonly>
        </div>
        <div class="col-md-12 form-group">
            {{ contrato_form.forma_pagamento.label_tag }}
            <div class="d-flex flex-wrap">
                {% for radio in contrato_form.forma_pagamento %}
                <div class="form-check me-3">
                    {{ radio.tag }}
                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                        {{ radio.choice_label }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% if contrato_form.forma_pagamento.errors %}
            <div class="invalid-feedback d-block">{{ contrato_form.forma_pagamento.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-12 form-group">
            {{ contrato_form.observacoes.label_tag }} <small class="text-muted">(opcional)</small>
            {{ contrato_form.observacoes }}
            {% if contrato_form.observacoes.errors %}
            <div class="invalid-feedback">{{ contrato_form.observacoes.errors }}</div>
            {% endif %}
        </div>

        <!-- BotÃ£o -->
        <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary" id="submit-button">Salvar</button>
            <span id="processing-message" style="display: none; color: green;">Processando... Por favor, aguarde.</span>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const mensalidadeInput = document.getElementById("id_valor_mensalidade");
    const vigenciaInput = document.getElementById("id_vigencia_meses");
    const totalInput = document.getElementById("valor_total");
    const dataPrimeiroPagamento = document.getElementById("id_data_vencimento_primeira_parcela");
    const dataUltimaParcela = document.getElementById("data_ultima_parcela");
    const form = document.getElementById('novo-contrato-form');
    const submitButton = document.getElementById('submit-button');
    const processingMessage = document.getElementById('processing-message');

    // FunÃ§Ã£o para calcular o valor total
    function calcularTotal() {
        const mensalidade = parseFloat(mensalidadeInput.value) || 0;
        const vigencia = parseInt(vigenciaInput.value) || 0;
        totalInput.value = (mensalidade * vigencia).toFixed(2);
    }

    // FunÃ§Ã£o para calcular a data da Ãºltima parcela
    function calcularDataUltimaParcela() {
        const vigencia = parseInt(vigenciaInput.value);
        const dataInicial = new Date(dataPrimeiroPagamento.value);
        if (vigencia && dataInicial && !isNaN(dataInicial)) {
            const dataFinal = new Date(dataInicial);
            dataFinal.setMonth(dataFinal.getMonth() + vigencia - 1);
            dataUltimaParcela.value = dataFinal.toISOString().split('T')[0];
        } else {
            dataUltimaParcela.value = '';
        }
    }

    // FunÃ§Ã£o para validar tempo_video (HH:MM:SS)
    function validarTempoVideo() {
        const tempoInput = document.getElementById("id_tempo_video");
        const tempo = tempoInput.value;
        const regex = /^\d{2}:\d{2}:\d{2}$/;
        if (tempo && !regex.test(tempo)) {
            tempoInput.classList.add('is-invalid');
            if (!tempoInput.nextElementSibling || !tempoInput.nextElementSibling.classList.contains('invalid-feedback')) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = 'O tempo do vÃ­deo deve estar no formato HH:MM:SS.';
                tempoInput.parentNode.appendChild(errorDiv);
            }
        } else {
            tempoInput.classList.remove('is-invalid');
            const errorDiv = tempoInput.nextElementSibling;
            if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                errorDiv.remove();
            }
        }
    }

    // Eventos
    mensalidadeInput.addEventListener("input", calcularTotal);
    vigenciaInput.addEventListener("input", function() {
        calcularTotal();
        calcularDataUltimaParcela();
    });
    dataPrimeiroPagamento.addEventListener("change", calcularDataUltimaParcela);
    document.getElementById("id_tempo_video").addEventListener("input", validarTempoVideo);

    // Evitar envio duplo e mostrar mensagem de processamento
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity() || document.getElementById("id_tempo_video").classList.contains('is-invalid')) {
            event.preventDefault();
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        submitButton.disabled = true;
        submitButton.style.display = 'none';
        processingMessage.style.display = 'inline';
    });
});
</script>
{% endblock %}